name: Build and Push prepare image

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: namespace-profile-default #ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compose image name and tag
        id: vars
        run: |
          image_name="ghcr.io/${{ github.repository_owner }}/prepare"
          image_tag="v2.15.0"

          # Docker/OCI repository names must be lowercase. Normalize the image
          # name to lowercase to avoid build errors.
          image_name_lc=$(echo "$image_name" | tr '[:upper:]' '[:lower:]')
          image_name="$image_name_lc"

          echo "image_name=$image_name"
          echo "image_tag=$image_tag"
          echo "image_name=$image_name" >> $GITHUB_OUTPUT
          echo "image_tag=$image_tag" >> $GITHUB_OUTPUT

      - name: Determine base build arguments
        id: build_args
        run: |
          # determine base image version (from VERSION file if present)
          if [ -f VERSION ]; then
            base_version=$(cat VERSION)
          else
            base_version=dev
          fi

          # default base namespace
          base_namespace=goharbor
          base_namespace=${{ github.repository_owner }}
          # normalize to lowercase for Docker repo naming rules
          base_namespace_lc=$(echo "$base_namespace" | tr '[:upper:]' '[:lower:]')
          base_namespace="$base_namespace_lc"

          base_namespace="ghcr.io/$base_namespace"
          base_image_name="$base_namespace/harbor-prepare-base"

          # normalize to lowercase for Docker repo naming rules
          base_image_name_lc=$(echo "$base_image_name" | tr '[:upper:]' '[:lower:]')
          base_image_name="$base_image_name_lc"

          echo "base_version=$base_version"
          echo "base_namespace=$base_namespace"
          echo "base_image_name=$base_image_name"
          echo "base_version=$base_version" >> $GITHUB_OUTPUT
          echo "base_namespace=$base_namespace" >> $GITHUB_OUTPUT
          echo "base_image_name=$base_image_name" >> $GITHUB_OUTPUT
   
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: "ghcr.io"
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push base image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: make/photon/prepare/Dockerfile.base
          platforms: linux/amd64
          push: true
          tags: "${{ steps.build_args.outputs.base_image_name }}:v2.15.0"
  
      - name: Build (and optionally push) the prepare image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: make/photon/prepare/Dockerfile
          platforms: linux/amd64
          push: true
          tags: "${{ steps.vars.outputs.image_name }}:v2.15.0"
          build-args: |
            harbor_base_image_version="v2.15.0"
            harbor_base_namespace="${{ steps.build_args.outputs.base_namespace }}"

      - name: Show result
        run: |
          echo "Built and pushed image: ${{ steps.vars.outputs.image_name }}:${{ steps.vars.outputs.image_tag }}"

